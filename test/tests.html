<!DOCTYPE html>  <html> <head>   <title>tests.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <meta name="generator" content="Docco">   <link rel="stylesheet" media="all" href="../stylesheets/docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>     <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               tests.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>documentation on writing tests here: http://docs.jquery.com/QUnit
example tests: https://github.com/jquery/qunit/blob/master/test/same.js
more examples: https://github.com/jquery/jquery/tree/master/test/unit
jQueryUI examples: https://github.com/jquery/jquery-ui/tree/master/tests/unit</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>sessionStorage.clear();</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">console</span> <span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">names</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;assert&#39;</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="s1">&#39;dirxml&#39;</span><span class="p">,</span>
	<span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;groupEnd&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;timeEnd&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="s1">&#39;profileEnd&#39;</span> <span class="p">];</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">console</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="p">)</span>
		<span class="nb">window</span><span class="p">.</span><span class="nx">console</span><span class="p">[</span> <span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">obj</span> <span class="p">)</span> <span class="p">{</span>
		<span class="nb">window</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">obj</span> <span class="p">);</span>
		<span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
	<span class="p">};</span>
	
	<span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Use the 'resource_uri' if possible</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;resource_uri&#39;</span> <span class="p">);</span>
		</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Try to have the collection construct a url</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">url</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">url</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">url</span> <span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
		<span class="p">}</span>
		</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Fallback to 'urlRoot'</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">url</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">urlRoot</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">urlRoot</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">url</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="s1">&#39;Url could not be determined!&#39;</span> <span class="p">);</span>
		<span class="p">}</span>
		
		<span class="k">return</span> <span class="nx">url</span><span class="p">;</span>
	<span class="p">};</span>


	<span class="cm">/**</span>
<span class="cm">	 * &#39;Zoo&#39;</span>
<span class="cm">	 */</span>

	<span class="nb">window</span><span class="p">.</span><span class="nx">Zoo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
			<span class="p">{</span>
				<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;animals&#39;</span><span class="p">,</span>
				<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;Animal&#39;</span><span class="p">,</span>
				<span class="nx">collectionType</span><span class="o">:</span> <span class="s1">&#39;AnimalCollection&#39;</span><span class="p">,</span>
				<span class="nx">collectionOptions</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">instance</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{</span> <span class="s1">&#39;url&#39;</span><span class="o">:</span> <span class="s1">&#39;zoo/&#39;</span> <span class="o">+</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">cid</span> <span class="o">+</span> <span class="s1">&#39;/animal/&#39;</span> <span class="p">}</span> <span class="p">},</span>
				<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;livesIn&#39;</span><span class="p">,</span>
					<span class="nx">includeInJSON</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span>
				<span class="p">}</span>
			<span class="p">},</span>
			<span class="p">{</span> <span class="c1">// A simple HasMany without recursive relation</span>
				<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;visitors&#39;</span><span class="p">,</span>
				<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;Visitor&#39;</span>
			<span class="p">}</span>
		<span class="p">]</span>
	<span class="p">});</span>

	<span class="nb">window</span><span class="p">.</span><span class="nx">Animal</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">urlRoot</span><span class="o">:</span> <span class="s1">&#39;/animal/&#39;</span><span class="p">,</span>
		</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>For validation testing. Wikipedia says elephants are reported up to 12.000 kg. Any more, we must've weighted wrong ;).</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">attrs</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">species</span> <span class="o">===</span> <span class="s1">&#39;elephant&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">weight</span> <span class="o">&amp;&amp;</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">weight</span> <span class="o">&gt;</span> <span class="mi">12000</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="s2">&quot;Too heavy.&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">});</span>

	<span class="nb">window</span><span class="p">.</span><span class="nx">AnimalCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">model</span><span class="o">:</span> <span class="nx">Animal</span><span class="p">,</span>
		
		<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">models</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">});</span>

	<span class="nb">window</span><span class="p">.</span><span class="nx">Visitor</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>


	<span class="cm">/**</span>
<span class="cm">	 * House/Person/Job/Company</span>
<span class="cm">	 */</span>

	<span class="nb">window</span><span class="p">.</span><span class="nx">House</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
				<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;occupants&#39;</span><span class="p">,</span>
				<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;Person&#39;</span><span class="p">,</span>
				<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;livesIn&#39;</span><span class="p">,</span>
					<span class="nx">includeInJSON</span><span class="o">:</span> <span class="kc">false</span>
				<span class="p">}</span>
			<span class="p">}]</span>
	<span class="p">});</span>

	<span class="nb">window</span><span class="p">.</span><span class="nx">User</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">urlRoot</span><span class="o">:</span> <span class="s1">&#39;/user/&#39;</span>
	<span class="p">});</span>

	<span class="nb">window</span><span class="p">.</span><span class="nx">Person</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
			<span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Create a cozy, recursive, one-to-one relationship</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;likesALot&#39;</span><span class="p">,</span>
				<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;Person&#39;</span><span class="p">,</span>
				<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
					<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;likedALotBy&#39;</span>
				<span class="p">}</span>
			<span class="p">},</span>
			<span class="p">{</span>
				<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
				<span class="nx">keyDestination</span><span class="o">:</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span>
				<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span>
				<span class="nx">includeInJSON</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">,</span>
				<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
					<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
					<span class="nx">includeInJSON</span><span class="o">:</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;person&#39;</span>
				<span class="p">}</span>
			<span class="p">},</span>
			<span class="p">{</span>
				<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;HasMany&#39;</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;jobs&#39;</span><span class="p">,</span>
				<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;Job&#39;</span><span class="p">,</span>
				<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;person&#39;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">]</span>
	<span class="p">});</span>

	<span class="nb">window</span><span class="p">.</span><span class="nx">PersonCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">model</span><span class="o">:</span> <span class="nx">Person</span>
	<span class="p">});</span>
	</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>A link table between 'Person' and 'Company', to achieve many-to-many relations</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nb">window</span><span class="p">.</span><span class="nx">Job</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
			<span class="s1">&#39;startDate&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
			<span class="s1">&#39;endDate&#39;</span><span class="o">:</span> <span class="kc">null</span>
		<span class="p">}</span>
	<span class="p">});</span>

	<span class="nb">window</span><span class="p">.</span><span class="nx">Company</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
				<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;HasMany&#39;</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;employees&#39;</span><span class="p">,</span>
				<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;Job&#39;</span><span class="p">,</span>
				<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;company&#39;</span>
				<span class="p">}</span>
			<span class="p">},</span>
			<span class="p">{</span>
				<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;HasOne&#39;</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;ceo&#39;</span><span class="p">,</span>
				<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;Person&#39;</span><span class="p">,</span>
				<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;runs&#39;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">]</span>
	<span class="p">});</span>



	<span class="nb">window</span><span class="p">.</span><span class="nx">Node</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
				<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;parent&#39;</span><span class="p">,</span>
				<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;Node&#39;</span><span class="p">,</span>
				<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;children&#39;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">]</span>
	<span class="p">});</span>

	<span class="nb">window</span><span class="p">.</span><span class="nx">NodeList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">model</span><span class="o">:</span> <span class="nx">Node</span>
	<span class="p">});</span>
	
	<span class="kd">function</span> <span class="nx">initObjects</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Reset last ajax requests</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nb">window</span><span class="p">.</span><span class="nx">requests</span> <span class="o">=</span> <span class="p">[];</span>
		</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>save _reverseRelations, otherwise we'll get a lot of warnings about existing relations</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">oldReverseRelations</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">_reverseRelations</span><span class="p">;</span>
		<span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Store</span><span class="p">();</span>
		<span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">_reverseRelations</span> <span class="o">=</span> <span class="nx">oldReverseRelations</span><span class="p">;</span>
		<span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">BlockingQueue</span><span class="p">();</span>

		<span class="nb">window</span><span class="p">.</span><span class="nx">person1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">({</span>
			<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;person-1&#39;</span><span class="p">,</span>
			<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;boy&#39;</span><span class="p">,</span>
			<span class="nx">likesALot</span><span class="o">:</span> <span class="s1">&#39;person-2&#39;</span><span class="p">,</span>
			<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;person-1&#39;</span><span class="p">,</span>
			<span class="nx">user</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;user-1&#39;</span><span class="p">,</span> <span class="nx">login</span><span class="o">:</span> <span class="s1">&#39;dude&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;me@gmail.com&#39;</span><span class="p">,</span> <span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;user-1&#39;</span> <span class="p">}</span>
		<span class="p">});</span>

		<span class="nb">window</span><span class="p">.</span><span class="nx">person2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">({</span>
			<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;person-2&#39;</span><span class="p">,</span>
			<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;girl&#39;</span><span class="p">,</span>
			<span class="nx">likesALot</span><span class="o">:</span> <span class="s1">&#39;person-1&#39;</span><span class="p">,</span>
			<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;person-2&#39;</span>
		<span class="p">});</span>

		<span class="nb">window</span><span class="p">.</span><span class="nx">person3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">({</span>
			<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;person-3&#39;</span><span class="p">,</span>
			<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;person-3&#39;</span>
		<span class="p">});</span>

		<span class="nb">window</span><span class="p">.</span><span class="nx">oldCompany</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Company</span><span class="p">({</span>
			<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;company-1&#39;</span><span class="p">,</span>
			<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Big Corp.&#39;</span><span class="p">,</span>
			<span class="nx">ceo</span><span class="o">:</span> <span class="p">{</span>
				<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Big Boy&#39;</span>
			<span class="p">},</span>
			<span class="nx">employees</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">person</span><span class="o">:</span> <span class="s1">&#39;person-3&#39;</span> <span class="p">}</span> <span class="p">],</span> <span class="c1">// uses the &#39;Job&#39; link table to achieve many-to-many. No &#39;id&#39; specified!</span>
			<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;company-1&#39;</span>
		<span class="p">});</span>

		<span class="nb">window</span><span class="p">.</span><span class="nx">newCompany</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Company</span><span class="p">({</span>
			<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;company-2&#39;</span><span class="p">,</span>
			<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;New Corp.&#39;</span><span class="p">,</span>
			<span class="nx">employees</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">person</span><span class="o">:</span> <span class="s1">&#39;person-2&#39;</span> <span class="p">}</span> <span class="p">],</span>
			<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;company-2&#39;</span>
		<span class="p">});</span>

		<span class="nb">window</span><span class="p">.</span><span class="nx">ourHouse</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">House</span><span class="p">({</span>
			<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;house-1&#39;</span><span class="p">,</span>
			<span class="nx">location</span><span class="o">:</span> <span class="s1">&#39;in the middle of the street&#39;</span><span class="p">,</span>
			<span class="nx">occupants</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;person-2&#39;</span><span class="p">],</span>
			<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;house-1&#39;</span>
		<span class="p">});</span>

		<span class="nb">window</span><span class="p">.</span><span class="nx">theirHouse</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">House</span><span class="p">({</span>
			<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;house-2&#39;</span><span class="p">,</span>
			<span class="nx">location</span><span class="o">:</span> <span class="s1">&#39;outside of town&#39;</span><span class="p">,</span>
			<span class="nx">occupants</span><span class="o">:</span> <span class="p">[],</span>
			<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;house-2&#39;</span>
		<span class="p">});</span>
	<span class="p">}</span>
	
	
	<span class="nx">module</span><span class="p">(</span> <span class="s2">&quot;Backbone.Semaphore&quot;</span><span class="p">,</span> <span class="p">{}</span> <span class="p">);</span>
	
	
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Unbounded&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">expect</span><span class="p">(</span> <span class="mi">10</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">semaphore</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="p">{},</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Semaphore</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="o">!</span><span class="nx">semaphore</span><span class="p">.</span><span class="nx">isLocked</span><span class="p">(),</span> <span class="s1">&#39;Semaphore is not locked initially&#39;</span> <span class="p">);</span>
			<span class="nx">semaphore</span><span class="p">.</span><span class="nx">acquire</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">semaphore</span><span class="p">.</span><span class="nx">isLocked</span><span class="p">(),</span> <span class="s1">&#39;Semaphore is locked after acquire&#39;</span> <span class="p">);</span>
			<span class="nx">semaphore</span><span class="p">.</span><span class="nx">acquire</span><span class="p">();</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">semaphore</span><span class="p">.</span><span class="nx">_permitsUsed</span><span class="p">,</span> <span class="mi">2</span> <span class="p">,</span><span class="s1">&#39;_permitsUsed should be incremented 2 times&#39;</span> <span class="p">);</span>
			
			<span class="nx">semaphore</span><span class="p">.</span><span class="nx">setAvailablePermits</span><span class="p">(</span> <span class="mi">4</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">semaphore</span><span class="p">.</span><span class="nx">_permitsAvailable</span><span class="p">,</span> <span class="mi">4</span> <span class="p">,</span><span class="s1">&#39;_permitsAvailable should be 4&#39;</span> <span class="p">);</span>
			
			<span class="nx">semaphore</span><span class="p">.</span><span class="nx">acquire</span><span class="p">();</span>
			<span class="nx">semaphore</span><span class="p">.</span><span class="nx">acquire</span><span class="p">();</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">semaphore</span><span class="p">.</span><span class="nx">_permitsUsed</span><span class="p">,</span> <span class="mi">4</span> <span class="p">,</span><span class="s1">&#39;_permitsUsed should be incremented 4 times&#39;</span> <span class="p">);</span>
			
			<span class="k">try</span> <span class="p">{</span>
				<span class="nx">semaphore</span><span class="p">.</span><span class="nx">acquire</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="k">catch</span><span class="p">(</span> <span class="nx">ex</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">ok</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;Error thrown when attempting to acquire too often&#39;</span> <span class="p">);</span>
			<span class="p">}</span>
			
			<span class="nx">semaphore</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">semaphore</span><span class="p">.</span><span class="nx">_permitsUsed</span><span class="p">,</span> <span class="mi">3</span> <span class="p">,</span><span class="s1">&#39;_permitsUsed should be decremented to 3&#39;</span> <span class="p">);</span>
			
			<span class="nx">semaphore</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
			<span class="nx">semaphore</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
			<span class="nx">semaphore</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">semaphore</span><span class="p">.</span><span class="nx">_permitsUsed</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span><span class="s1">&#39;_permitsUsed should be decremented to 0&#39;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="o">!</span><span class="nx">semaphore</span><span class="p">.</span><span class="nx">isLocked</span><span class="p">(),</span> <span class="s1">&#39;Semaphore is not locked when all permits are released&#39;</span> <span class="p">);</span>
			
			<span class="k">try</span> <span class="p">{</span>
				<span class="nx">semaphore</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="k">catch</span><span class="p">(</span> <span class="nx">ex</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nx">ok</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;Error thrown when attempting to release too often&#39;</span> <span class="p">);</span>
			<span class="p">}</span>
		<span class="p">});</span>
	
	
	<span class="nx">module</span><span class="p">(</span> <span class="s2">&quot;Backbone.BlockingQueue&quot;</span><span class="p">,</span> <span class="p">{}</span> <span class="p">);</span>
	
	
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Block&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">BlockingQueue</span><span class="p">();</span>
			<span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">increment</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">count</span><span class="o">++</span><span class="p">;</span> <span class="p">};</span>
			<span class="kd">var</span> <span class="nx">decrement</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">count</span><span class="o">--</span><span class="p">;</span> <span class="p">};</span>
			
			<span class="nx">queue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">increment</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">count</span> <span class="o">===</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Increment executed right away&#39;</span> <span class="p">);</span>
			
			<span class="nx">queue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">decrement</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Decrement executed right away&#39;</span> <span class="p">);</span>
			
			<span class="nx">queue</span><span class="p">.</span><span class="nx">block</span><span class="p">();</span>
			<span class="nx">queue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">increment</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">isLocked</span><span class="p">(),</span> <span class="s1">&#39;Queue is blocked&#39;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Increment did not execute right away&#39;</span> <span class="p">);</span>
			
			<span class="nx">queue</span><span class="p">.</span><span class="nx">block</span><span class="p">();</span>
			<span class="nx">queue</span><span class="p">.</span><span class="nx">block</span><span class="p">();</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">_permitsUsed</span><span class="p">,</span> <span class="mi">3</span> <span class="p">,</span><span class="s1">&#39;_permitsUsed should be incremented to 3&#39;</span> <span class="p">);</span>
			
			<span class="nx">queue</span><span class="p">.</span><span class="nx">unblock</span><span class="p">();</span>
			<span class="nx">queue</span><span class="p">.</span><span class="nx">unblock</span><span class="p">();</span>
			<span class="nx">queue</span><span class="p">.</span><span class="nx">unblock</span><span class="p">();</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Increment executed&#39;</span> <span class="p">);</span>
		<span class="p">});</span>
	
	
	<span class="nx">module</span><span class="p">(</span> <span class="s2">&quot;Backbone.Store&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">setup</span><span class="o">:</span> <span class="nx">initObjects</span> <span class="p">}</span> <span class="p">);</span>
	
	
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Initialized&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">_collections</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;Store contains 5 collections&quot;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;getObjectByName&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getObjectByName</span><span class="p">(</span> <span class="s1">&#39;Backbone&#39;</span> <span class="p">),</span> <span class="nx">Backbone</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getObjectByName</span><span class="p">(</span> <span class="s1">&#39;Backbone.RelationalModel&#39;</span> <span class="p">),</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Add and remove from store&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">coll</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span> <span class="nx">person1</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
			
			<span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">({</span>
				<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;person-10&#39;</span><span class="p">,</span>
				<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Remi&#39;</span><span class="p">,</span>
				<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;person-10&#39;</span>
			<span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Collection size increased by 1&quot;</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">person</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Trigger the 'success' callback to fire the 'destroy' event</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">request</span><span class="p">.</span><span class="nx">success</span><span class="p">();</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">length</span><span class="p">,</span> <span class="s2">&quot;Collection size decreased by 1&quot;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Models are created from objects, can then be found, destroyed, cannot be found anymore&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">houseId</span> <span class="o">=</span> <span class="s1">&#39;house-10&#39;</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">personId</span> <span class="o">=</span> <span class="s1">&#39;person-10&#39;</span><span class="p">;</span>
			
			<span class="kd">var</span> <span class="nx">anotherHouse</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">House</span><span class="p">({</span>
				<span class="nx">id</span><span class="o">:</span> <span class="nx">houseId</span><span class="p">,</span>
				<span class="nx">location</span><span class="o">:</span> <span class="s1">&#39;no country for old men&#39;</span><span class="p">,</span>
				<span class="nx">resource_uri</span><span class="o">:</span> <span class="nx">houseId</span><span class="p">,</span>
				<span class="nx">occupants</span><span class="o">:</span> <span class="p">[{</span>
					<span class="nx">id</span><span class="o">:</span> <span class="nx">personId</span><span class="p">,</span>
					<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Remi&#39;</span><span class="p">,</span>
					<span class="nx">resource_uri</span><span class="o">:</span> <span class="nx">personId</span>
				<span class="p">}]</span>
			<span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">anotherHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;occupants&#39;</span><span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">,</span> <span class="s2">&quot;Occupants is a Collection&quot;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">anotherHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;occupants&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="nx">personId</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Person</span><span class="p">,</span> <span class="s2">&quot;Occupants contains the Person with id=&#39;&quot;</span> <span class="o">+</span> <span class="nx">personId</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Person</span><span class="p">,</span> <span class="nx">personId</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person</span><span class="p">,</span> <span class="s2">&quot;Person with id=&quot;</span> <span class="o">+</span> <span class="nx">personId</span> <span class="o">+</span> <span class="s2">&quot; is found in the store&quot;</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">person</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Trigger the 'success' callback to fire the 'destroy' event</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">request</span><span class="p">.</span><span class="nx">success</span><span class="p">();</span>
			
			<span class="nx">person</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Person</span><span class="p">,</span> <span class="nx">personId</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="o">!</span><span class="nx">person</span><span class="p">,</span> <span class="nx">personId</span> <span class="o">+</span> <span class="s2">&quot; is not found in the store anymore&quot;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="o">!</span><span class="nx">anotherHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;occupants&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="nx">personId</span> <span class="p">),</span> <span class="s2">&quot;Occupants no longer contains the Person with id=&#39;&quot;</span> <span class="o">+</span> <span class="nx">personId</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="p">);</span>
			
			<span class="nx">request</span> <span class="o">=</span> <span class="nx">anotherHouse</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Trigger the 'success' callback to fire the 'destroy' event</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">request</span><span class="p">.</span><span class="nx">success</span><span class="p">();</span>
			
			<span class="kd">var</span> <span class="nx">house</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">House</span><span class="p">,</span> <span class="nx">houseId</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="o">!</span><span class="nx">house</span><span class="p">,</span> <span class="nx">houseId</span> <span class="o">+</span> <span class="s2">&quot; is not found in the store anymore&quot;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Model.collection is the first collection a Model is added to by an end-user (not it&#39;s Backbone.Store collection!)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">(</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;New guy&#39;</span> <span class="p">}</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">personColl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PersonCollection</span><span class="p">();</span>
			<span class="nx">personColl</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">person</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person</span><span class="p">.</span><span class="nx">collection</span> <span class="o">===</span> <span class="nx">personColl</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;All models can be found after adding them to a Collection via &#39;Collection.reset&#39;&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="p">[</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="kc">null</span> <span class="p">},</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="mi">4</span> <span class="p">},</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
			<span class="p">];</span>
			
			<span class="kd">var</span> <span class="nx">nodeList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NodeList</span><span class="p">();</span>
			<span class="nx">nodeList</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span> <span class="nx">nodes</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">storeColl</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span> <span class="nx">Node</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">storeColl</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;Every Node is in Backbone.Relational.store&quot;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Node</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Node</span><span class="p">,</span> <span class="s2">&quot;Node 1 can be found&quot;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Node</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Node</span><span class="p">,</span> <span class="s2">&quot;Node 2 can be found&quot;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Node</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Node</span><span class="p">,</span> <span class="s2">&quot;Node 3 can be found&quot;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Node</span><span class="p">,</span> <span class="mi">4</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Node</span><span class="p">,</span> <span class="s2">&quot;Node 4 can be found&quot;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Inheritance creates and uses a separate collection&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">whale</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Animal</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;whale&#39;</span> <span class="p">}</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Animal</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">whale</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">numCollections</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">_collections</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
			
			<span class="kd">var</span> <span class="nx">Mammal</span> <span class="o">=</span> <span class="nx">Animal</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">urlRoot</span><span class="o">:</span> <span class="s1">&#39;/mammal/&#39;</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">lion</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mammal</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;lion&#39;</span> <span class="p">}</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">donkey</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mammal</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;donkey&#39;</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">_collections</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">numCollections</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Animal</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">whale</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Mammal</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">lion</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Mammal</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">donkey</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">Primate</span> <span class="o">=</span> <span class="nx">Mammal</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">urlRoot</span><span class="o">:</span> <span class="s1">&#39;/primate/&#39;</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">gorilla</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Primate</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;gorilla&#39;</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">_collections</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">numCollections</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Primate</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">gorilla</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Inheritance with `subModelTypes` uses the same collection as the model&#39;s super&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Mammal</span> <span class="o">=</span> <span class="nx">Animal</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">subModelTypes</span><span class="o">:</span> <span class="p">{</span>
					<span class="s1">&#39;primate&#39;</span><span class="o">:</span> <span class="s1">&#39;Primate&#39;</span><span class="p">,</span>
					<span class="s1">&#39;carnivore&#39;</span><span class="o">:</span> <span class="s1">&#39;Carnivore&#39;</span>
				<span class="p">}</span>
			<span class="p">});</span>

			<span class="kd">var</span> <span class="nx">whale</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mammal</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;whale&#39;</span> <span class="p">}</span> <span class="p">);</span>

			<span class="kd">var</span> <span class="nx">numCollections</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">_collections</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

			<span class="nb">window</span><span class="p">.</span><span class="nx">Primate</span> <span class="o">=</span> <span class="nx">Mammal</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">Carnivore</span> <span class="o">=</span> <span class="nx">Mammal</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>

			<span class="kd">var</span> <span class="nx">lion</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Carnivore</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;lion&#39;</span> <span class="p">}</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">wolf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Carnivore</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;wolf&#39;</span> <span class="p">}</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">_collections</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">numCollections</span><span class="p">,</span> <span class="s2">&quot;`_collections` should have remained the same&quot;</span> <span class="p">);</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Mammal</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">whale</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Mammal</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">lion</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Mammal</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">wolf</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Carnivore</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">!==</span> <span class="nx">whale</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Carnivore</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">lion</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Carnivore</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">wolf</span> <span class="p">);</span>

			<span class="kd">var</span> <span class="nx">gorilla</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Primate</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;gorilla&#39;</span> <span class="p">}</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">_collections</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">numCollections</span><span class="p">,</span> <span class="s2">&quot;`_collections` should have remained the same&quot;</span> <span class="p">);</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Animal</span><span class="p">,</span> <span class="mi">4</span> <span class="p">)</span> <span class="o">!==</span> <span class="nx">gorilla</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Mammal</span><span class="p">,</span> <span class="mi">4</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">gorilla</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">Primate</span><span class="p">,</span> <span class="mi">4</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">gorilla</span> <span class="p">);</span>

			<span class="k">delete</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Primate</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Carnivore</span><span class="p">;</span>
		<span class="p">});</span>
		
	
	<span class="nx">module</span><span class="p">(</span> <span class="s2">&quot;Backbone.RelationalModel&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">setup</span><span class="o">:</span> <span class="nx">initObjects</span> <span class="p">}</span> <span class="p">);</span>
		
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Return values: set returns the Model&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">personId</span> <span class="o">=</span> <span class="s1">&#39;person-10&#39;</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">({</span>
				<span class="nx">id</span><span class="o">:</span> <span class="nx">personId</span><span class="p">,</span>
				<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Remi&#39;</span><span class="p">,</span>
				<span class="nx">resource_uri</span><span class="o">:</span> <span class="nx">personId</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">person</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="s1">&#39;name&#39;</span><span class="o">:</span> <span class="s1">&#39;Hector&#39;</span> <span class="p">}</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">result</span> <span class="o">===</span> <span class="nx">person</span><span class="p">,</span> <span class="s2">&quot;Set returns the model&quot;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;getRelations&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">getRelations</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span> <span class="mi">6</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;getRelation&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">rel</span> <span class="o">=</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">getRelation</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;fetchRelated on a HasOne relation&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">errorCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">({</span>
				<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;person-10&#39;</span><span class="p">,</span>
				<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;person-10&#39;</span><span class="p">,</span>
				<span class="nx">user</span><span class="o">:</span> <span class="s1">&#39;user-10&#39;</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">requests</span> <span class="o">=</span> <span class="nx">person</span><span class="p">.</span><span class="nx">fetchRelated</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
					<span class="nx">errorCount</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">requests</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">requests</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;A request has been made&quot;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">User</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Triggering the 'error' callback should destroy the model</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">requests</span><span class="p">[</span> <span class="mi">0</span> <span class="p">].</span><span class="nx">error</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Trigger the 'success' callback to fire the 'destroy' event</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nb">window</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span> <span class="nb">window</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">].</span><span class="nx">success</span><span class="p">();</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;User has been destroyed &amp; removed&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">errorCount</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;The error callback executed successfully&quot;</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">person2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">({</span>
				<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;person-10&#39;</span><span class="p">,</span>
				<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;person-10&#39;</span>
			<span class="p">});</span>
			
			<span class="nx">requests</span> <span class="o">=</span> <span class="nx">person2</span><span class="p">.</span><span class="nx">fetchRelated</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">requests</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;No request was made&quot;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;fetchRelated on a HasMany relation&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">errorCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">zoo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zoo</span><span class="p">({</span>
				<span class="nx">animals</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;lion-1&#39;</span><span class="p">,</span> <span class="s1">&#39;zebra-1&#39;</span> <span class="p">]</span>
			<span class="p">});</span>
			</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Case 1: separate requests for each model</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">requests</span> <span class="o">=</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">fetchRelated</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">errorCount</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">requests</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">requests</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Two requests have been made (a separate one for each animal)&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Two animals in the zoo&quot;</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Triggering the 'error' callback for either request should destroy the model</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">requests</span><span class="p">[</span> <span class="mi">0</span> <span class="p">].</span><span class="nx">error</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Trigger the 'success' callback to fire the 'destroy' event</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nb">window</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span> <span class="nb">window</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">].</span><span class="nx">success</span><span class="p">();</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;One animal left in the zoo&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">errorCount</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;The error callback executed successfully&quot;</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Case 2: one request per fetch (generated by the collection)</p>

<p>Give 'zoo' a custom url function that builds a url to fetch a set of models from their ids</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">errorCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">url</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">models</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="s1">&#39;/animal/&#39;</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">models</span> <span class="o">?</span> <span class="s1">&#39;set/&#39;</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span> <span class="nx">models</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span> <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span> <span class="p">);</span>
			<span class="p">};</span>
			</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Set two new animals to be fetched; both should be fetched in a single request</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">zoo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">animals</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;lion-2&#39;</span><span class="p">,</span> <span class="s1">&#39;zebra-2&#39;</span> <span class="p">]</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
			
			<span class="nx">requests</span> <span class="o">=</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">fetchRelated</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">errorCount</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">requests</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">requests</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">requests</span><span class="p">[</span> <span class="mi">0</span> <span class="p">].</span><span class="nx">url</span> <span class="o">===</span> <span class="s1">&#39;/animal/set/lion-2;zebra-2/&#39;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;animals&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Triggering the 'error' callback (some error occured during fetching) should trigger the 'destroy' event
on both fetched models, but should NOT actually make 'delete' requests to the server!</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">numRequests</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
			<span class="nx">requests</span><span class="p">[</span> <span class="mi">0</span> <span class="p">].</span><span class="nx">error</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nb">window</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">numRequests</span><span class="p">,</span> <span class="s2">&quot;An error occured when fetching, but no DELETE requests are made to the server while handling local cleanup.&quot;</span> <span class="p">);</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Both animals are destroyed&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">errorCount</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;The error callback executed successfully for both models&quot;</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Re-fetch them</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">requests</span> <span class="o">=</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">fetchRelated</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">);</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">requests</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>No more animals to fetch!</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">requests</span> <span class="o">=</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">fetchRelated</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">requests</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">requests</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
		<span class="p">});</span>

		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;clone&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>HasOne relations should stay with the original model</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">newPerson</span> <span class="o">=</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">newPerson</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">user</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;toJSON&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;First node&#39;</span> <span class="p">});</span>
			<span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Second node&#39;</span> <span class="p">});</span>
			<span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Third node&#39;</span> <span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>console.debug( json );</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">ok</span><span class="p">(</span> <span class="nx">json</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">);</span>
		<span class="p">});</span>

		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;constructor.findOrCreate&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">personColl</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span> <span class="nx">person1</span> <span class="p">),</span>
				<span class="nx">origPersonCollSize</span> <span class="o">=</span> <span class="nx">personColl</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Just find an existing model</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">findOrCreate</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">id</span> <span class="p">);</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person</span> <span class="o">===</span> <span class="nx">person1</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">origPersonCollSize</span> <span class="o">===</span> <span class="nx">personColl</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&quot;Existing person was found (none created)&quot;</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Update an existing model</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">person</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">findOrCreate</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;dude&#39;</span> <span class="p">}</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;name&#39;</span> <span class="p">),</span> <span class="s1">&#39;dude&#39;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;name&#39;</span> <span class="p">),</span> <span class="s1">&#39;dude&#39;</span> <span class="p">);</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">origPersonCollSize</span> <span class="o">===</span> <span class="nx">personColl</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&quot;Existing person was updated (none created)&quot;</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Look for a non-existent person; 'options.create' is false</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">person</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">findOrCreate</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">5001</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">create</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span> <span class="p">);</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="o">!</span><span class="nx">person</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">origPersonCollSize</span> <span class="o">===</span> <span class="nx">personColl</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&quot;No person was found (none created)&quot;</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Create a new model</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">person</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">findOrCreate</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">5001</span> <span class="p">}</span> <span class="p">);</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person</span> <span class="k">instanceof</span> <span class="nx">Person</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">origPersonCollSize</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">===</span> <span class="nx">personColl</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&quot;No person was found (1 created)&quot;</span> <span class="p">);</span>
		<span class="p">});</span>

	
	<span class="nx">module</span><span class="p">(</span> <span class="s2">&quot;Backbone.RelationalModel inheritance (`subModelTypes`)&quot;</span><span class="p">,</span> <span class="p">{}</span> <span class="p">);</span>


		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Object building based on type, when using explicit collections&quot;</span> <span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Mammal</span> <span class="o">=</span> <span class="nx">Animal</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">subModelTypes</span><span class="o">:</span> <span class="p">{</span>
					<span class="s1">&#39;primate&#39;</span><span class="o">:</span> <span class="s1">&#39;Primate&#39;</span><span class="p">,</span>
					<span class="s1">&#39;carnivore&#39;</span><span class="o">:</span> <span class="s1">&#39;Carnivore&#39;</span>
				<span class="p">}</span>
			<span class="p">});</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">Primate</span> <span class="o">=</span> <span class="nx">Mammal</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">Carnivore</span> <span class="o">=</span> <span class="nx">Mammal</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>

			<span class="kd">var</span> <span class="nx">MammalCollection</span> <span class="o">=</span> <span class="nx">AnimalCollection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">model</span><span class="o">:</span> <span class="nx">Mammal</span>
			<span class="p">});</span>

			<span class="kd">var</span> <span class="nx">mammals</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MammalCollection</span><span class="p">(</span> <span class="p">[</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;chimp&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;primate&#39;</span> <span class="p">},</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;panther&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;carnivore&#39;</span> <span class="p">}</span>
			<span class="p">]);</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">mammals</span><span class="p">.</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Primate</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">mammals</span><span class="p">.</span><span class="nx">at</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Carnivore</span> <span class="p">);</span>

			<span class="k">delete</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Carnivore</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Primate</span><span class="p">;</span>
		<span class="p">});</span>

		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Object building based on type, when used in relations&quot;</span> <span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">PetAnimal</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">subModelTypes</span><span class="o">:</span> <span class="p">{</span>
					<span class="s1">&#39;cat&#39;</span><span class="o">:</span> <span class="s1">&#39;Cat&#39;</span><span class="p">,</span>
					<span class="s1">&#39;dog&#39;</span><span class="o">:</span> <span class="s1">&#39;Dog&#39;</span>
				<span class="p">}</span>
			<span class="p">});</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">Dog</span> <span class="o">=</span> <span class="nx">PetAnimal</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">Cat</span> <span class="o">=</span> <span class="nx">PetAnimal</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>

			<span class="kd">var</span> <span class="nx">PetPerson</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
					<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;pets&#39;</span><span class="p">,</span>
					<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">PetAnimal</span><span class="p">,</span>
					<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;owner&#39;</span>
					<span class="p">}</span>
				<span class="p">}]</span>
			<span class="p">});</span>

			<span class="kd">var</span> <span class="nx">petPerson</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PetPerson</span><span class="p">({</span>
				<span class="nx">pets</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span>
						<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Spot&#39;</span>
					<span class="p">},</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span>
						<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Whiskers&#39;</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">petPerson</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;pets&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Dog</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">petPerson</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;pets&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Cat</span> <span class="p">);</span>

			<span class="nx">petPerson</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;pets&#39;</span> <span class="p">).</span><span class="nx">add</span><span class="p">({</span>
				<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span>
				<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Spot II&#39;</span>
			<span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">petPerson</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;pets&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span> <span class="mi">2</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Dog</span> <span class="p">);</span>

			<span class="k">delete</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Dog</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Cat</span><span class="p">;</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Automatic sharing of &#39;superModel&#39; relations&quot;</span> <span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">PetPerson</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">PetAnimal</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">subModelTypes</span><span class="o">:</span> <span class="p">{</span>
					<span class="s1">&#39;dog&#39;</span><span class="o">:</span> <span class="s1">&#39;Dog&#39;</span>
				<span class="p">},</span>

				<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
					<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
					<span class="nx">key</span><span class="o">:</span>  <span class="s1">&#39;owner&#39;</span><span class="p">,</span>
					<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">PetPerson</span><span class="p">,</span>
					<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;pets&#39;</span>
					<span class="p">}</span>
				<span class="p">}]</span>
			<span class="p">});</span>
			
			<span class="nb">window</span><span class="p">.</span><span class="nx">Flea</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">Dog</span> <span class="o">=</span> <span class="nx">PetAnimal</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
					<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
					<span class="nx">key</span><span class="o">:</span>	<span class="s1">&#39;fleas&#39;</span><span class="p">,</span>
					<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Flea</span><span class="p">,</span>
					<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;host&#39;</span>
					<span class="p">}</span>
				<span class="p">}]</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">dog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dog</span><span class="p">({</span>
				<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Spot&#39;</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PetPerson</span><span class="p">({</span>
				<span class="nx">pets</span><span class="o">:</span> <span class="p">[</span> <span class="nx">dog</span> <span class="p">]</span>
			<span class="p">});</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">dog</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;owner&#39;</span> <span class="p">),</span> <span class="nx">person</span><span class="p">,</span> <span class="s2">&quot;Dog has a working owner relation.&quot;</span> <span class="p">);</span>

			<span class="kd">var</span> <span class="nx">flea</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Flea</span><span class="p">({</span>
				<span class="nx">host</span><span class="o">:</span> <span class="nx">dog</span>
			<span class="p">});</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">dog</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;fleas&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">),</span> <span class="nx">flea</span><span class="p">,</span> <span class="s2">&quot;Dog has a working fleas relation.&quot;</span> <span class="p">);</span>

			<span class="k">delete</span> <span class="nb">window</span><span class="p">.</span><span class="nx">PetPerson</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nb">window</span><span class="p">.</span><span class="nx">PetAnimal</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Flea</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Dog</span><span class="p">;</span>
		<span class="p">});</span>
	
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;toJSON includes the type&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">PetAnimal</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">subModelTypes</span><span class="o">:</span> <span class="p">{</span>
					<span class="s1">&#39;dog&#39;</span><span class="o">:</span> <span class="s1">&#39;Dog&#39;</span>
				<span class="p">}</span>
			<span class="p">});</span>

			<span class="nb">window</span><span class="p">.</span><span class="nx">Dog</span> <span class="o">=</span> <span class="nx">PetAnimal</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>
			
			<span class="kd">var</span> <span class="nx">dog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dog</span><span class="p">({</span>
				<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Spot&#39;</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">dog</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">json</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="s2">&quot;The value of &#39;type&#39; is the pet animal&#39;s type.&quot;</span> <span class="p">);</span>

			<span class="k">delete</span> <span class="nb">window</span><span class="p">.</span><span class="nx">PetAnimal</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Dog</span><span class="p">;</span>
		<span class="p">});</span>
		
	
	<span class="nx">module</span><span class="p">(</span> <span class="s2">&quot;Backbone.Relation options&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">setup</span><span class="o">:</span> <span class="nx">initObjects</span> <span class="p">}</span> <span class="p">);</span>
		
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;&#39;includeInJSON&#39; (Person to JSON)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">json</span><span class="p">.</span><span class="nx">user_id</span><span class="p">,</span> <span class="s1">&#39;user-1&#39;</span><span class="p">,</span> <span class="s2">&quot;The value of &#39;user_id&#39; is the user&#39;s id (not an object, since &#39;includeInJSON&#39; is set to the idAttribute)&quot;</span> <span class="p">);</span>
			<span class="nx">ok</span> <span class="p">(</span> <span class="nx">json</span><span class="p">.</span><span class="nx">likesALot</span> <span class="k">instanceof</span> <span class="nb">Object</span><span class="p">,</span> <span class="s2">&quot;The value of &#39;likesALot&#39; is an object (&#39;includeInJSON&#39; is &#39;true&#39;)&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">json</span><span class="p">.</span><span class="nx">likesALot</span><span class="p">.</span><span class="nx">likesALot</span><span class="p">,</span> <span class="s1">&#39;person-1&#39;</span><span class="p">,</span> <span class="s2">&quot;Person is serialized only once&quot;</span> <span class="p">);</span>
			
			<span class="nx">json</span> <span class="o">=</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">).</span><span class="nx">toJSON</span><span class="p">();</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">json</span><span class="p">.</span><span class="nx">person</span><span class="p">,</span> <span class="s1">&#39;boy&#39;</span><span class="p">,</span> <span class="s2">&quot;The value of &#39;person&#39; is the person&#39;s name (&#39;includeInJSON is set to &#39;name&#39;)&quot;</span> <span class="p">);</span>
			
			<span class="nx">json</span> <span class="o">=</span> <span class="nx">person2</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;livesIn&#39;</span><span class="p">)</span> <span class="k">instanceof</span> <span class="nx">House</span><span class="p">,</span> <span class="s2">&quot;&#39;person2&#39; has a &#39;livesIn&#39; relation&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">json</span><span class="p">.</span><span class="nx">livesIn</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">,</span> <span class="s2">&quot;The value of &#39;livesIn&#39; is not serialized (&#39;includeInJSON is &#39;false&#39;)&quot;</span> <span class="p">);</span>
			
			<span class="nx">json</span> <span class="o">=</span> <span class="nx">person3</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">json</span><span class="p">.</span><span class="nx">user_id</span> <span class="o">===</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;The value of &#39;user_id&#39; is null&quot;</span><span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">json</span><span class="p">.</span><span class="nx">likesALot</span> <span class="o">===</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;The value of &#39;likesALot&#39; is null&quot;</span><span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;&#39;createModels&#39; is false&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">NewUser</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
			<span class="kd">var</span> <span class="nx">NewPerson</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
					<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
					<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">NewUser</span><span class="p">,</span>
					<span class="nx">createModels</span><span class="o">:</span> <span class="kc">false</span>
				<span class="p">}]</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NewPerson</span><span class="p">({</span>
				<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;newperson-1&#39;</span><span class="p">,</span>
				<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;newperson-1&#39;</span><span class="p">,</span>
				<span class="nx">user</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;newuser-1&#39;</span><span class="p">,</span> <span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;newuser-1&#39;</span> <span class="p">}</span>
			<span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NewUser</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;newuser-1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;SuperUser&#39;</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">user</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Old data gets overwritten by the explicitly created user, since a model was never created from the old data</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;resource_uri&#39;</span> <span class="p">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">);</span>
		<span class="p">});</span>

		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;&#39;keySource&#39; loads from &#39;key&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Property</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">idAttribute</span><span class="o">:</span> <span class="s1">&#39;property_id&#39;</span>
			<span class="p">});</span>
			<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">idAttribute</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span>

				<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
					<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;properties&#39;</span><span class="p">,</span>
					<span class="nx">keySource</span><span class="o">:</span> <span class="s1">&#39;property_ids&#39;</span><span class="p">,</span>
					<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Property</span><span class="p">,</span>
					<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span>
						<span class="nx">keySource</span><span class="o">:</span> <span class="s1">&#39;view_id&#39;</span>
					<span class="p">}</span>
				<span class="p">}]</span>
			<span class="p">});</span>

			<span class="kd">var</span> <span class="nx">property1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Property</span><span class="p">({</span>
				<span class="nx">property_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span>
				<span class="nx">value</span><span class="o">:</span> <span class="mi">500</span><span class="p">,</span>
				<span class="nx">view_id</span><span class="o">:</span> <span class="mi">5</span>
			<span class="p">});</span>

			<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">({</span>
				<span class="nx">id</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
				<span class="nx">property_ids</span><span class="o">:</span> <span class="p">[</span> <span class="mi">2</span> <span class="p">]</span>
			<span class="p">});</span>

			<span class="kd">var</span> <span class="nx">property2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Property</span><span class="p">({</span>
				<span class="nx">property_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span>
				<span class="nx">value</span><span class="o">:</span> <span class="mi">400</span>
			<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>The values from view.property_ids should be loaded into view.properties</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;properties&#39;</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">view</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;properties&#39;</span> <span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;&#39;view&#39; has two &#39;properties&#39;&quot;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">view</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;property_ids&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;view&#39; does not have &#39;property_ids&#39;&quot;</span> <span class="p">);</span>
		<span class="p">});</span>

		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;&#39;keyDestination&#39; saves to &#39;key&#39;&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Property</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">idAttribute</span><span class="o">:</span> <span class="s1">&#39;property_id&#39;</span>
			<span class="p">});</span>
			<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">idAttribute</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span>

				<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
					<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;properties&#39;</span><span class="p">,</span>
					<span class="nx">keyDestination</span><span class="o">:</span> <span class="s1">&#39;properties_attributes&#39;</span><span class="p">,</span>
					<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Property</span><span class="p">,</span>
					<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span>
						<span class="nx">keyDestination</span><span class="o">:</span> <span class="s1">&#39;view_attributes&#39;</span><span class="p">,</span>
						<span class="nx">includeInJSON</span><span class="o">:</span> <span class="kc">true</span>
					<span class="p">}</span>
				<span class="p">}]</span>
			<span class="p">});</span>

			<span class="kd">var</span> <span class="nx">property1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Property</span><span class="p">({</span>
				<span class="nx">property_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span>
				<span class="nx">value</span><span class="o">:</span> <span class="mi">500</span><span class="p">,</span>
				<span class="nx">view</span><span class="o">:</span> <span class="mi">5</span>
			<span class="p">});</span>

			<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">({</span>
				<span class="nx">id</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
				<span class="nx">properties</span><span class="o">:</span> <span class="p">[</span> <span class="mi">2</span> <span class="p">]</span>
			<span class="p">});</span>

			<span class="kd">var</span> <span class="nx">property2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Property</span><span class="p">({</span>
				<span class="nx">property_id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
				<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span>
				<span class="nx">value</span><span class="o">:</span> <span class="mi">400</span>
			<span class="p">});</span>

			<span class="kd">var</span> <span class="nx">viewJSON</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">viewJSON</span><span class="p">.</span><span class="nx">properties_attributes</span> <span class="o">&amp;&amp;</span> <span class="nx">viewJSON</span><span class="p">.</span><span class="nx">properties_attributes</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;&#39;viewJSON&#39; has two &#39;properties_attributes&#39;&quot;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">viewJSON</span><span class="p">.</span><span class="nx">properties</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;viewJSON&#39; does not have &#39;properties&#39;&quot;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;&#39;collectionOptions&#39; sets the options on the created HasMany Collections&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">zoo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zoo</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;animals&quot;</span><span class="p">).</span><span class="nx">url</span> <span class="o">===</span> <span class="s2">&quot;zoo/&quot;</span> <span class="o">+</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">cid</span> <span class="o">+</span> <span class="s2">&quot;/animal/&quot;</span><span class="p">);</span>
		<span class="p">});</span>
		
		
	<span class="nx">module</span><span class="p">(</span> <span class="s2">&quot;Backbone.Relation preconditions&quot;</span> <span class="p">);</span>
		
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;&#39;type&#39;, &#39;key&#39;, &#39;relatedModel&#39; are required properties&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Properties</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
			<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;listProperties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">);</span>
			
			<span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">);</span>
			
			<span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;listProperties&#39;</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;&#39;type&#39; can be a string or an object reference&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Properties</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
			<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;Backbone.HasOne&#39;</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;listProperties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">);</span>
			
			<span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;HasOne&#39;</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;listProperties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">);</span>
			
			<span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;listProperties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;&#39;key&#39; can be a string or an object reference&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Properties</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
			<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;listProperties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">);</span>
			
			<span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;listProperties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;HasMany with a reverseRelation HasMany is not allowed&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Password</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
					<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;HasMany&#39;</span><span class="p">,</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span>
					<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span>
					<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;HasMany&#39;</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;passwords&#39;</span>
					<span class="p">}</span>
				<span class="p">}]</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Password</span><span class="p">({</span>
				<span class="nx">plaintext</span><span class="o">:</span> <span class="s1">&#39;qwerty&#39;</span><span class="p">,</span>
				<span class="nx">users</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;person-1&#39;</span><span class="p">,</span> <span class="s1">&#39;person-2&#39;</span><span class="p">,</span> <span class="s1">&#39;person-3&#39;</span> <span class="p">]</span>
			<span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">password</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;No _relations created on Password&quot;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Duplicate relations not allowed (two simple relations)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Properties</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
			<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;properties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span>
					<span class="p">},</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;properties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">();</span>
			<span class="nx">view</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">properties</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Properties</span><span class="p">()</span> <span class="p">}</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Duplicate relations not allowed (one relation with a reverse relation, one without)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Properties</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
			<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;properties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span><span class="p">,</span>
						<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
							<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
							<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span>
						<span class="p">}</span>
					<span class="p">},</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;properties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">();</span>
			<span class="nx">view</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">properties</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Properties</span><span class="p">()</span> <span class="p">}</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Duplicate relations not allowed (two relations with reverse relations)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Properties</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
			<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;properties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span><span class="p">,</span>
						<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
							<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
							<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span>
						<span class="p">}</span>
					<span class="p">},</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;properties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span><span class="p">,</span>
						<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
							<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
							<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">();</span>
			<span class="nx">view</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">properties</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Properties</span><span class="p">()</span> <span class="p">}</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Duplicate relations not allowed (different relations, reverse relations)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Properties</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
			<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;listProperties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span><span class="p">,</span>
						<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
							<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
							<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span>
						<span class="p">}</span>
					<span class="p">},</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;windowProperties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span><span class="p">,</span>
						<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
							<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
							<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">();</span>
			<span class="kd">var</span> <span class="nx">prop1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Properties</span><span class="p">(</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;a&#39;</span> <span class="p">}</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">prop2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Properties</span><span class="p">(</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;b&#39;</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">view</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">listProperties</span><span class="o">:</span> <span class="nx">prop1</span><span class="p">,</span> <span class="nx">windowProperties</span><span class="o">:</span> <span class="nx">prop2</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">prop1</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;listProperties&#39;</span> <span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;name&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;a&#39;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;windowProperties&#39;</span> <span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;name&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;b&#39;</span> <span class="p">);</span>
		<span class="p">});</span>
		
	
	<span class="nx">module</span><span class="p">(</span> <span class="s2">&quot;Backbone.Relation general&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">setup</span><span class="o">:</span> <span class="nx">initObjects</span> <span class="p">}</span> <span class="p">);</span>
		
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Only valid models (no validation failure) should be added to a relation&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">zoo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zoo</span><span class="p">();</span>
			
			<span class="nx">zoo</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;add:animals&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">animal</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">ok</span><span class="p">(</span> <span class="nx">animal</span> <span class="k">instanceof</span> <span class="nx">Animal</span> <span class="p">);</span>
				<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">smallElephant</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Animal</span><span class="p">(</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Jumbo&#39;</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;elephant&#39;</span><span class="p">,</span> <span class="nx">weight</span><span class="o">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="nx">livesIn</span><span class="o">:</span> <span class="nx">zoo</span> <span class="p">}</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Just 1 elephant in the zoo&quot;</span> <span class="p">);</span>
			
			<span class="k">try</span> <span class="p">{</span>
				<span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Big guy&#39;</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;elephant&#39;</span><span class="p">,</span> <span class="nx">weight</span><span class="o">:</span> <span class="mi">13000</span> <span class="p">}</span> <span class="p">);</span>
			<span class="p">}</span>
			<span class="k">catch</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Throws an error in new verions of backbone after failing validation.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">}</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Still just 1 elephant in the zoo&quot;</span> <span class="p">);</span>
		<span class="p">});</span>

		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;collections can also be passed as attributes on creation&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">animals</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AnimalCollection</span><span class="p">([</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;Lion&#39;</span> <span class="p">},</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span> <span class="p">,</span><span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;Zebra&#39;</span> <span class="p">}</span>
			<span class="p">]);</span>

			<span class="kd">var</span> <span class="nx">zoo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zoo</span><span class="p">(</span> <span class="p">{</span> <span class="nx">animals</span><span class="o">:</span> <span class="nx">animals</span> <span class="p">}</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">),</span> <span class="nx">animals</span><span class="p">,</span> <span class="s2">&quot;The &#39;animals&#39; collection has been set as the zoo&#39;s animals&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Two animals in &#39;zoo&#39;&quot;</span> <span class="p">);</span>

			<span class="nx">zoo</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>

			<span class="kd">var</span> <span class="nx">newZoo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zoo</span><span class="p">(</span> <span class="p">{</span> <span class="nx">animals</span><span class="o">:</span> <span class="nx">animals</span><span class="p">.</span><span class="nx">models</span> <span class="p">}</span> <span class="p">);</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">newZoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Two animals in the &#39;newZoo&#39;&quot;</span> <span class="p">);</span>
		<span class="p">});</span>

		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;models can also be passed as attributes on creation&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">artis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zoo</span><span class="p">(</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Artis&#39;</span> <span class="p">}</span> <span class="p">);</span>

			<span class="kd">var</span> <span class="nx">animal</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Animal</span><span class="p">(</span> <span class="p">{</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;Hippo&#39;</span><span class="p">,</span> <span class="nx">livesIn</span><span class="o">:</span> <span class="nx">artis</span> <span class="p">});</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">artis</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">),</span> <span class="nx">animal</span><span class="p">,</span> <span class="s2">&quot;Artis has a Hippo&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">animal</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;livesIn&#39;</span> <span class="p">),</span> <span class="nx">artis</span><span class="p">,</span> <span class="s2">&quot;The Hippo is in Artis&quot;</span> <span class="p">);</span>
		<span class="p">});</span>


	<span class="nx">module</span><span class="p">(</span> <span class="s2">&quot;Backbone.HasOne&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">setup</span><span class="o">:</span> <span class="nx">initObjects</span> <span class="p">}</span> <span class="p">);</span>
		
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;HasOne relations on Person are set up properly&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;likesALot&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">person2</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">).</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;user-1&#39;</span><span class="p">,</span> <span class="s2">&quot;The id of &#39;person1&#39;s user is &#39;user-1&#39;&quot;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;likesALot&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">person1</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Reverse HasOne relations on Person are set up properly&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;likedALotBy&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">person2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;person&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">person1</span><span class="p">,</span> <span class="s2">&quot;The person belonging to &#39;person1&#39;s user is &#39;person1&#39;&quot;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;likedALotBy&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">person1</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;&#39;set&#39; triggers &#39;change&#39; and &#39;update&#39;, on a HasOne relation, for a Model with multiple relations&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">expect</span><span class="p">(</span> <span class="mi">9</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">Password</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
					<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
					<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span>
					<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;password&#39;</span>
					<span class="p">}</span>
				<span class="p">}]</span>
			<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>triggers initialization of the reverse relation from User to Password</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Password</span><span class="p">(</span> <span class="p">{</span> <span class="nx">plaintext</span><span class="o">:</span> <span class="s1">&#39;asdf&#39;</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">person1</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">ok</span><span class="p">(</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">User</span><span class="p">,</span> <span class="s2">&quot;model.user is an instance of User&quot;</span> <span class="p">);</span>
					<span class="nx">equal</span><span class="p">(</span> <span class="nx">model</span><span class="p">.</span><span class="nx">previous</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;login&#39;</span> <span class="p">),</span> <span class="nx">oldLogin</span><span class="p">,</span> <span class="s2">&quot;previousAttributes is available on &#39;change&#39;&quot;</span> <span class="p">);</span>
				<span class="p">});</span>
			
			<span class="nx">person1</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;change:user&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">ok</span><span class="p">(</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">User</span><span class="p">,</span> <span class="s2">&quot;model.user is an instance of User&quot;</span> <span class="p">);</span>
					<span class="nx">equal</span><span class="p">(</span> <span class="nx">model</span><span class="p">.</span><span class="nx">previous</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;login&#39;</span> <span class="p">),</span> <span class="nx">oldLogin</span><span class="p">,</span> <span class="s2">&quot;previousAttributes is available on &#39;change&#39;&quot;</span> <span class="p">);</span>
				<span class="p">});</span>
			
			<span class="nx">person1</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;update:user&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">ok</span><span class="p">(</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">User</span><span class="p">,</span> <span class="s2">&quot;model.user is an instance of User&quot;</span> <span class="p">);</span>
					<span class="nx">ok</span><span class="p">(</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;person&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">person1</span><span class="p">,</span> <span class="s2">&quot;The user&#39;s &#39;person&#39; is &#39;person1&#39;&quot;</span> <span class="p">);</span>
					<span class="nx">ok</span><span class="p">(</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;password&#39;</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Password</span><span class="p">,</span> <span class="s2">&quot;The user&#39;s password attribute is a model of type Password&quot;</span><span class="p">);</span>
					<span class="nx">equal</span><span class="p">(</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;password&#39;</span> <span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;plaintext&#39;</span> <span class="p">),</span> <span class="s1">&#39;qwerty&#39;</span><span class="p">,</span> <span class="s2">&quot;The user&#39;s password is &#39;&#39;qwerty&#39;&quot;</span> <span class="p">);</span>
				<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">login</span><span class="o">:</span> <span class="s1">&#39;me@hotmail.com&#39;</span><span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="p">{</span> <span class="nx">plaintext</span><span class="o">:</span> <span class="s1">&#39;qwerty&#39;</span> <span class="p">}</span> <span class="p">};</span>
			<span class="kd">var</span> <span class="nx">oldLogin</span> <span class="o">=</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;login&#39;</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Triggers first # assertions</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">person1</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">user</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">user</span> <span class="o">=</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">).</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;update:password&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">equal</span><span class="p">(</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;plaintext&#39;</span> <span class="p">),</span> <span class="s1">&#39;asdf&#39;</span><span class="p">,</span> <span class="s2">&quot;The user&#39;s password is &#39;&#39;qwerty&#39;&quot;</span> <span class="p">);</span>
				<span class="p">});</span>
			</pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Triggers last assertion</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">user</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span> <span class="p">}</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;&#39;unset&#39; triggers &#39;change&#39; and &#39;update:&#39;&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">expect</span><span class="p">(</span> <span class="mi">4</span> <span class="p">);</span>
			
			<span class="nx">person1</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">equal</span><span class="p">(</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;model.user is unset&quot;</span> <span class="p">);</span>
				<span class="p">});</span>
			
			<span class="nx">person1</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;update:user&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">equal</span><span class="p">(</span> <span class="nx">attr</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;new value of attr (user) is null&quot;</span> <span class="p">);</span>
				<span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">User</span><span class="p">,</span> <span class="s2">&quot;person1 has a &#39;user&#39;&quot;</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">);</span>
			<span class="nx">person1</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">);</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;person&#39;</span> <span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;person1 is not set on &#39;user&#39; anymore&quot;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;&#39;clear&#39; triggers &#39;change&#39; and &#39;update:&#39;&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">expect</span><span class="p">(</span> <span class="mi">4</span> <span class="p">);</span>
			
			<span class="nx">person1</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">equal</span><span class="p">(</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;model.user is unset&quot;</span> <span class="p">);</span>
				<span class="p">});</span>
			
			<span class="nx">person1</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;update:user&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">equal</span><span class="p">(</span> <span class="nx">attr</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;new value of attr (user) is null&quot;</span> <span class="p">);</span>
				<span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">User</span><span class="p">,</span> <span class="s2">&quot;person1 has a &#39;user&#39;&quot;</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">);</span>
			<span class="nx">person1</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;person&#39;</span> <span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;person1 is not set on &#39;user&#39; anymore&quot;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		
	<span class="nx">module</span><span class="p">(</span> <span class="s2">&quot;Backbone.HasMany&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">setup</span><span class="o">:</span> <span class="nx">initObjects</span> <span class="p">}</span> <span class="p">);</span>
	
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Listeners on &#39;add&#39;/&#39;remove&#39;&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">expect</span><span class="p">(</span> <span class="mi">7</span> <span class="p">);</span>
			
			<span class="nx">ourHouse</span>
				<span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;add:occupants&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">ok</span><span class="p">(</span> <span class="nx">model</span> <span class="o">===</span> <span class="nx">person1</span><span class="p">,</span> <span class="s2">&quot;model === person1&quot;</span> <span class="p">);</span>
					<span class="p">})</span>
				<span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;remove:occupants&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">ok</span><span class="p">(</span> <span class="nx">model</span> <span class="o">===</span> <span class="nx">person1</span><span class="p">,</span> <span class="s2">&quot;model === person1&quot;</span> <span class="p">);</span>
					<span class="p">});</span>
			
			<span class="nx">theirHouse</span>
				<span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;add:occupants&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">ok</span><span class="p">(</span> <span class="nx">model</span> <span class="o">===</span> <span class="nx">person1</span><span class="p">,</span> <span class="s2">&quot;model === person1&quot;</span> <span class="p">);</span>
					<span class="p">})</span>
				<span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;remove:occupants&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">ok</span><span class="p">(</span> <span class="nx">model</span> <span class="o">===</span> <span class="nx">person1</span><span class="p">,</span> <span class="s2">&quot;model === person1&quot;</span> <span class="p">);</span>
					<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="nx">person1</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;update:livesIn&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">attr</span> <span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span> <span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">ok</span><span class="p">(</span> <span class="nx">attr</span> <span class="o">===</span> <span class="nx">ourHouse</span><span class="p">,</span> <span class="s2">&quot;model === ourHouse&quot;</span> <span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">count</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">ok</span><span class="p">(</span> <span class="nx">attr</span> <span class="o">===</span> <span class="nx">theirHouse</span><span class="p">,</span> <span class="s2">&quot;model === theirHouse&quot;</span> <span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">count</span> <span class="o">===</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">ok</span><span class="p">(</span> <span class="nx">attr</span> <span class="o">===</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;model === null&quot;</span> <span class="p">);</span>
					<span class="p">}</span>
					
					<span class="nx">count</span><span class="o">++</span><span class="p">;</span>
				<span class="p">});</span>
			
			<span class="nx">ourHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">add</span><span class="p">(</span> <span class="nx">person1</span> <span class="p">);</span>
			<span class="nx">person1</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="s1">&#39;livesIn&#39;</span><span class="o">:</span> <span class="nx">theirHouse</span> <span class="p">}</span> <span class="p">);</span>
			<span class="nx">theirHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">person1</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Listeners for &#39;add&#39;/&#39;remove&#39;, on a HasMany relation, for a Model with multiple relations&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">company</span><span class="o">:</span> <span class="nx">oldCompany</span> <span class="p">};</span>
			<span class="kd">var</span> <span class="nx">job2</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">company</span><span class="o">:</span> <span class="nx">oldCompany</span><span class="p">,</span> <span class="nx">person</span><span class="o">:</span> <span class="nx">person1</span> <span class="p">};</span>
			<span class="kd">var</span> <span class="nx">job3</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">person</span><span class="o">:</span> <span class="nx">person1</span> <span class="p">};</span>
			<span class="kd">var</span> <span class="nx">newJob</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
			
			<span class="nx">newCompany</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;add:employees&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">ok</span><span class="p">(</span> <span class="kc">false</span><span class="p">,</span> <span class="s2">&quot;person1 should only be added to &#39;oldCompany&#39;.&quot;</span> <span class="p">);</span>
				<span class="p">});</span>
			</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Assert that all relations on a Model are set up, before notifying related models.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">oldCompany</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;add:employees&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">newJob</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
					
					<span class="nx">ok</span><span class="p">(</span> <span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Job</span> <span class="p">);</span>
					<span class="nx">ok</span><span class="p">(</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;company&#39;</span><span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Company</span> <span class="o">&amp;&amp;</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Person</span><span class="p">,</span>
						<span class="s2">&quot;Both Person and Company are set on the Job instance&quot;</span> <span class="p">);</span>
				<span class="p">});</span>
			
			<span class="nx">person1</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;add:jobs&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span> <span class="p">)</span> <span class="p">{</span>
					<span class="nx">ok</span><span class="p">(</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;company&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">oldCompany</span> <span class="o">&amp;&amp;</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;person&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">person1</span><span class="p">,</span>
						<span class="s2">&quot;Both Person and Company are set on the Job instance&quot;</span> <span class="p">);</span>
				<span class="p">});</span>
			</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Add job1 and job2 to the 'Person' side of the relation</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">jobs</span> <span class="o">=</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;jobs&#39;</span> <span class="p">);</span>
			
			<span class="nx">jobs</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">job1</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">jobs</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;jobs.length is 1&quot;</span> <span class="p">);</span>
			
			<span class="nx">newJob</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">jobs</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;jobs.length is 0&quot;</span> <span class="p">);</span>
			
			<span class="nx">jobs</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">job2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">jobs</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;jobs.length is 1&quot;</span> <span class="p">);</span>
			
			<span class="nx">newJob</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">jobs</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;jobs.length is 0&quot;</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Add job1 and job2 to the 'Company' side of the relation</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">employees</span> <span class="o">=</span> <span class="nx">oldCompany</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;employees&#39;</span><span class="p">);</span>
			
			<span class="nx">employees</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">job3</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">employees</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;employees.length is 2&quot;</span> <span class="p">);</span>
			
			<span class="nx">newJob</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">employees</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;employees.length is 1&quot;</span> <span class="p">);</span>
			
			<span class="nx">employees</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">job2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">employees</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;employees.length is 2&quot;</span> <span class="p">);</span>
			
			<span class="nx">newJob</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">employees</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;employees.length is 1&quot;</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Create a stand-alone Job ;)</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">new</span> <span class="nx">Job</span><span class="p">({</span>
				<span class="nx">person</span><span class="o">:</span> <span class="nx">person1</span><span class="p">,</span>
				<span class="nx">company</span><span class="o">:</span> <span class="nx">oldCompany</span>
			<span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">jobs</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">employees</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;jobs.length is 1 and employees.length is 2&quot;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;The Collections used for HasMany relations are re-used if possible&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">collId</span> <span class="o">=</span> <span class="nx">ourHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			
			<span class="nx">ourHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">add</span><span class="p">(</span> <span class="nx">person1</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">ourHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">collId</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Set a value on 'occupants' that would cause the relation to be reset.
The collection itself should be kept (along with it's properties)</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">ourHouse</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="s1">&#39;occupants&#39;</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;person-1&#39;</span> <span class="p">]</span> <span class="p">}</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">ourHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">collId</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">ourHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Setting a new collection loses the original collection</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">ourHouse</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="s1">&#39;occupants&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">()</span> <span class="p">}</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">ourHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">id</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">);</span>
		<span class="p">});</span>


		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Setting a new collection or array of ids updates the relation&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">zoo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zoo</span><span class="p">();</span>

			<span class="kd">var</span> <span class="nx">visitors</span> <span class="o">=</span> <span class="p">[</span>
				<span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Paul&#39;</span> <span class="p">}</span>
			<span class="p">];</span>

			<span class="nx">zoo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="s1">&#39;visitors&#39;</span><span class="p">,</span> <span class="nx">visitors</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;visitors&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

			<span class="nx">zoo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="s1">&#39;visitors&#39;</span><span class="p">,</span> <span class="p">[]</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;visitors&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
		<span class="p">});</span>

		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Setting a custom collection in &#39;collectionType&#39; uses that collection for instantiation&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">zoo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zoo</span><span class="p">();</span>
			</pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Set values so that the relation gets filled</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">zoo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
				<span class="nx">animals</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;Lion&#39;</span> <span class="p">},</span>
					<span class="p">{</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;Zebra&#39;</span> <span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			</pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Check that the animals were created</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">ok</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;species&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;Lion&#39;</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span> <span class="mi">1</span> <span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;species&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;Zebra&#39;</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Check that the generated collection is of the correct kind</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">ok</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">AnimalCollection</span> <span class="p">);</span>
		<span class="p">});</span>

		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Setting a new collection maintains that collection&#39;s current &#39;models&#39;&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">zoo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zoo</span><span class="p">();</span>

			<span class="kd">var</span> <span class="nx">animals</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AnimalCollection</span><span class="p">([</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;Lion&#39;</span> <span class="p">},</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span> <span class="p">,</span><span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;Zebra&#39;</span> <span class="p">}</span>
			<span class="p">]);</span>

			<span class="nx">zoo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span><span class="p">,</span> <span class="nx">animals</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>

			<span class="kd">var</span> <span class="nx">newAnimals</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AnimalCollection</span><span class="p">([</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;Zebra&#39;</span> <span class="p">},</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;Elephant&#39;</span> <span class="p">},</span>
				<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;Tiger&#39;</span> <span class="p">}</span>
			<span class="p">]);</span>

			<span class="nx">zoo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span><span class="p">,</span> <span class="nx">newAnimals</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">3</span> <span class="p">);</span>
		<span class="p">});</span>

		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Models found in &#39;findRelated&#39; are all added in one go (so &#39;sort&#39; will only be called once)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
				<span class="nx">sort</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sort</span><span class="p">;</span>

			<span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
				<span class="nx">count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">};</span>

			<span class="nx">AnimalCollection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">comparator</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span>

			<span class="kd">var</span> <span class="nx">zoo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zoo</span><span class="p">({</span>
				<span class="nx">animals</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;Lion&#39;</span> <span class="p">},</span>
					<span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span> <span class="p">,</span><span class="nx">species</span><span class="o">:</span> <span class="s1">&#39;Zebra&#39;</span> <span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Sort is called only once&quot;</span> <span class="p">);</span>

			<span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sort</span> <span class="o">=</span> <span class="nx">sort</span><span class="p">;</span>
			<span class="k">delete</span> <span class="nx">AnimalCollection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">comparator</span><span class="p">;</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;The &#39;collectionKey&#39; options is used to create references on generated Collections back to its RelationalModel&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">zoo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zoo</span><span class="p">({</span>
				<span class="nx">animals</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;lion-1&#39;</span><span class="p">,</span> <span class="s1">&#39;zebra-1&#39;</span> <span class="p">]</span>
			<span class="p">});</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">livesIn</span><span class="p">,</span> <span class="nx">zoo</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">zoo</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>

			<span class="kd">var</span> <span class="nx">Barn</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;animals&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;Animal&#39;</span><span class="p">,</span>
						<span class="nx">collectionType</span><span class="o">:</span> <span class="s1">&#39;AnimalCollection&#39;</span><span class="p">,</span>
						<span class="nx">collectionKey</span><span class="o">:</span> <span class="s1">&#39;barn&#39;</span><span class="p">,</span>
						<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
							<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;livesIn&#39;</span><span class="p">,</span>
							<span class="nx">includeInJSON</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span>
						<span class="p">}</span>
					<span class="p">}]</span>
			<span class="p">});</span>
			<span class="kd">var</span> <span class="nx">barn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Barn</span><span class="p">({</span>
				<span class="nx">animals</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;chicken-1&#39;</span><span class="p">,</span> <span class="s1">&#39;cow-1&#39;</span> <span class="p">]</span>
			<span class="p">});</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">barn</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">livesIn</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">barn</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">barn</span><span class="p">,</span> <span class="nx">barn</span> <span class="p">);</span>

			<span class="kd">var</span> <span class="nx">BarnNoKey</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;animals&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="s1">&#39;Animal&#39;</span><span class="p">,</span>
						<span class="nx">collectionType</span><span class="o">:</span> <span class="s1">&#39;AnimalCollection&#39;</span><span class="p">,</span>
						<span class="nx">collectionKey</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
						<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
							<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;livesIn&#39;</span><span class="p">,</span>
							<span class="nx">includeInJSON</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span>
						<span class="p">}</span>
					<span class="p">}]</span>
			<span class="p">});</span>
			<span class="kd">var</span> <span class="nx">barnNoKey</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BarnNoKey</span><span class="p">({</span>
				<span class="nx">animals</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;chicken-1&#39;</span><span class="p">,</span> <span class="s1">&#39;cow-1&#39;</span> <span class="p">]</span>
			<span class="p">});</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">barnNoKey</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">livesIn</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">barnNoKey</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">barn</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>
		<span class="p">});</span>

		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Handle edge-cases where the server supplies a single Object/id instead of an Array&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">zoo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zoo</span><span class="p">({</span>
				<span class="nx">animals</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;lion-1&#39;</span> <span class="p">}</span>
			<span class="p">});</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;There is 1 animal in the zoo&quot;</span> <span class="p">);</span>

			<span class="nx">zoo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;lion-2&#39;</span> <span class="p">}</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;There is 1 animal in the zoo&quot;</span> <span class="p">);</span>
		<span class="p">});</span>

		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Polymorhpic relations&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">Location</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>

			<span class="kd">var</span> <span class="nx">Locatable</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;locations&#39;</span><span class="p">,</span>
						<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;HasMany&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Location</span><span class="p">,</span>
						<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
							<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;locatable&#39;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>

			<span class="kd">var</span> <span class="nx">FirstLocatable</span> <span class="o">=</span> <span class="nx">Locatable</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>
			<span class="kd">var</span> <span class="nx">SecondLocatable</span> <span class="o">=</span> <span class="nx">Locatable</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>

			<span class="kd">var</span> <span class="nx">firstLocatable</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FirstLocatable</span><span class="p">();</span>
			<span class="kd">var</span> <span class="nx">secondLocatable</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SecondLocatable</span><span class="p">();</span>

			<span class="kd">var</span> <span class="nx">firstLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Location</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">locatable</span><span class="o">:</span> <span class="nx">firstLocatable</span> <span class="p">}</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">secondLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Location</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">locatable</span><span class="o">:</span> <span class="nx">secondLocatable</span> <span class="p">}</span> <span class="p">);</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">firstLocatable</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;locations&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">firstLocation</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">firstLocatable</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;locations&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;locatable&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">firstLocatable</span> <span class="p">);</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">secondLocatable</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;locations&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">secondLocation</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">secondLocatable</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;locations&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">).</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;locatable&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">secondLocatable</span> <span class="p">);</span>
		<span class="p">});</span>
		
		
	<span class="nx">module</span><span class="p">(</span> <span class="s2">&quot;Reverse relationships&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">setup</span><span class="o">:</span> <span class="nx">initObjects</span> <span class="p">}</span> <span class="p">);</span>
	
	
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Add and remove&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">ourHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ourHouse has 1 occupant&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;livesIn&#39;</span> <span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;Person 1 doesn&#39;t live anywhere&quot;</span> <span class="p">);</span>
			
			<span class="nx">ourHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">add</span><span class="p">(</span> <span class="nx">person1</span> <span class="p">);</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">ourHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Our House has 2 occupants&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;livesIn&#39;</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;livesIn&#39;</span><span class="p">).</span><span class="nx">id</span><span class="p">,</span> <span class="nx">ourHouse</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s2">&quot;Person 1 lives in ourHouse&quot;</span> <span class="p">);</span>
			
			<span class="nx">person1</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="s1">&#39;livesIn&#39;</span><span class="o">:</span> <span class="nx">theirHouse</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">theirHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;theirHouse has 1 occupant&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">ourHouse</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;occupants&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ourHouse has 1 occupant&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;livesIn&#39;</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;livesIn&#39;</span><span class="p">).</span><span class="nx">id</span><span class="p">,</span> <span class="nx">theirHouse</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s2">&quot;Person 1 lives in theirHouse&quot;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;HasOne relations to self (tree stucture)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">child1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;First child&#39;</span> <span class="p">});</span>
			<span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Parent&#39;</span> <span class="p">});</span>
			<span class="kd">var</span> <span class="nx">child2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Second child&#39;</span> <span class="p">});</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">include</span><span class="p">(</span> <span class="nx">child1</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">include</span><span class="p">(</span> <span class="nx">child2</span> <span class="p">)</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">child1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;parent&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">parent</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">child1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">child2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;parent&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">parent</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">child2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;HasMany relations to self (tree structure)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">child1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;First child&#39;</span> <span class="p">});</span>
			<span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">children</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span> <span class="p">],</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Parent&#39;</span> <span class="p">});</span>
			<span class="kd">var</span> <span class="nx">child2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Second child&#39;</span> <span class="p">});</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">include</span><span class="p">(</span> <span class="nx">child1</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">include</span><span class="p">(</span> <span class="nx">child2</span> <span class="p">)</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">child1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;parent&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">parent</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">child1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">child2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;parent&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">parent</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">child2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;HasOne relations to self (cycle, directed graph structure)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">node1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;First node&#39;</span> <span class="p">});</span>
			<span class="kd">var</span> <span class="nx">node2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Second node&#39;</span> <span class="p">});</span>
			<span class="kd">var</span> <span class="nx">node3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Third node&#39;</span> <span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">node1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;parent&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">node3</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">node1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">node1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="nx">node2</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">node2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;parent&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">node1</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">node2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">node2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="nx">node3</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">node3</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;parent&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">node2</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">node3</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">node3</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;children&#39;</span> <span class="p">).</span><span class="nx">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="nx">node1</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;New objects (no &#39;id&#39; yet) have working relations&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">({</span>
				<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Remi&#39;</span>
			<span class="p">});</span>
			
			<span class="nx">person</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">user</span><span class="o">:</span> <span class="p">{</span> <span class="nx">login</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">user1</span> <span class="o">=</span> <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">user1</span> <span class="k">instanceof</span> <span class="nx">User</span><span class="p">,</span> <span class="s2">&quot;User created on Person&quot;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">user1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">),</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s2">&quot;person.user is the correct User&quot;</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">user2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">({</span>
				<span class="nx">login</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
				<span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span>
			<span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">user2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;person&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;&#39;user&#39; doesn&#39;t belong to a &#39;person&#39; yet&quot;</span> <span class="p">);</span>
			
			<span class="nx">person</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">user2</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">user1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;person&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">user2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">user2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;person&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">person</span> <span class="p">);</span>
			
			<span class="nx">person2</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">user2</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">user2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">user2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;person&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">person2</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;&#39;Save&#39; objects (performing &#39;set&#39; multiple times without and with id)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>
			
			<span class="nx">person3</span>
				<span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;add:jobs&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span> <span class="p">)</span> <span class="p">{</span>
						<span class="kd">var</span> <span class="nx">company</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;company&#39;</span><span class="p">);</span>
						<span class="nx">ok</span><span class="p">(</span> <span class="nx">company</span> <span class="k">instanceof</span> <span class="nx">Company</span> <span class="o">&amp;&amp;</span> <span class="nx">company</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;ceo&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;Lunar boy&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">person3</span><span class="p">,</span>
							<span class="s2">&quot;Both Person and Company are set on the Job instance&quot;</span> <span class="p">);</span>
					<span class="p">})</span>
				<span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;remove:jobs&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span> <span class="p">)</span> <span class="p">{</span>
						<span class="nx">ok</span><span class="p">(</span> <span class="kc">false</span><span class="p">,</span> <span class="s2">&quot;&#39;person3&#39; should not lose his job&quot;</span> <span class="p">);</span>
					<span class="p">});</span>
			</pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Create Models from an object</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">company</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Company</span><span class="p">({</span>
				<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Luna Corp.&#39;</span><span class="p">,</span>
				<span class="nx">ceo</span><span class="o">:</span> <span class="p">{</span>
					<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Lunar boy&#39;</span>
				<span class="p">},</span>
				<span class="nx">employees</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">person</span><span class="o">:</span> <span class="s1">&#39;person-3&#39;</span> <span class="p">}</span> <span class="p">]</span>
			<span class="p">});</span>
			</pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Backbone.save executes "model.set(model.parse(resp), options)". Set a full map over object, but now with ids.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">company</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
				<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;company-3&#39;</span><span class="p">,</span>
				<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Big Corp.&#39;</span><span class="p">,</span>
				<span class="nx">ceo</span><span class="o">:</span> <span class="p">{</span>
					<span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;person-4&#39;</span><span class="p">,</span>
					<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Lunar boy&#39;</span><span class="p">,</span>
					<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;person-4&#39;</span>
				<span class="p">},</span>
				<span class="nx">employees</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;job-1&#39;</span><span class="p">,</span> <span class="nx">person</span><span class="o">:</span> <span class="s1">&#39;person-3&#39;</span><span class="p">,</span> <span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;job-1&#39;</span> <span class="p">}</span> <span class="p">],</span>
				<span class="nx">resource_uri</span><span class="o">:</span> <span class="s1">&#39;company-3&#39;</span>
			<span class="p">});</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Set the same value a couple of time, by &#39;id&#39; and object&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">person1</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">likesALot</span><span class="o">:</span> <span class="s1">&#39;person-2&#39;</span> <span class="p">}</span> <span class="p">);</span>
			<span class="nx">person1</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">likesALot</span><span class="o">:</span> <span class="nx">person2</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;likesALot&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">person2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;likedALotBy&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">person1</span> <span class="p">);</span>
			
			<span class="nx">person1</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">likesALot</span><span class="o">:</span> <span class="s1">&#39;person-2&#39;</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;likesALot&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">person2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;likedALotBy&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">person1</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Numerical keys&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">child1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;First child&#39;</span> <span class="p">});</span>
			<span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">children</span><span class="o">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Parent&#39;</span> <span class="p">});</span>
			<span class="kd">var</span> <span class="nx">child2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Second child&#39;</span> <span class="p">});</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">).</span><span class="nx">include</span><span class="p">(</span> <span class="nx">child1</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">).</span><span class="nx">include</span><span class="p">(</span> <span class="nx">child2</span> <span class="p">)</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">child1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">parent</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">child1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">child2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">parent</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">child2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Relations that use refs to other models (instead of keys)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">child1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;First child&#39;</span> <span class="p">});</span>
			<span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">children</span><span class="o">:</span> <span class="p">[</span><span class="nx">child1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Parent&#39;</span> <span class="p">});</span>
			<span class="kd">var</span> <span class="nx">child2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Second child&#39;</span> <span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">child1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">parent</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">child1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">).</span><span class="nx">include</span><span class="p">(</span> <span class="nx">child1</span> <span class="p">)</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">).</span><span class="nx">include</span><span class="p">(</span> <span class="nx">child2</span> <span class="p">)</span> <span class="p">);</span>
			
			<span class="kd">var</span> <span class="nx">child3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">parent</span><span class="o">:</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Second child&#39;</span> <span class="p">});</span>
			
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">3</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">).</span><span class="nx">include</span><span class="p">(</span> <span class="nx">child3</span> <span class="p">)</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">child3</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">parent</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">child3</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Add an already existing model (reverseRelation shouldn&#39;t exist yet) to a relation as a hash&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>This test caused a race condition to surface:
The 'relation's constructor initializes the 'reverseRelation', which called 'relation.addRelated' in it's 'initialize'.
However, 'relation's 'initialize' has not been executed yet, so it doesn't have a 'related' collection yet.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">Properties</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
			<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[</span>
					<span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;properties&#39;</span><span class="p">,</span>
						<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">Properties</span><span class="p">,</span>
						<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
							<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
							<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">]</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Properties</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;300px&#39;</span><span class="p">,</span> <span class="nx">view</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">({</span>
				<span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				<span class="nx">properties</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;300px&#39;</span><span class="p">,</span> <span class="nx">view</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">]</span>
			<span class="p">});</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">props</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;view&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">view</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;properties&#39;</span> <span class="p">).</span><span class="nx">include</span><span class="p">(</span> <span class="nx">props</span> <span class="p">)</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Reverse relations are found for models that have not been instantiated and use .extend()&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="p">});</span>
			<span class="kd">var</span> <span class="nx">Property</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
					<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span>
					<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">View</span><span class="p">,</span>
					<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;properties&#39;</span>
					<span class="p">}</span>
				<span class="p">}]</span>
			<span class="p">});</span>

			<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">({</span>
				<span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				<span class="nx">properties</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;300px&#39;</span> <span class="p">}</span> <span class="p">]</span>
			<span class="p">});</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;properties&#39;</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Reverse relations found for models that have not been instantiated and run .setup() manually&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Generated from CoffeeScript code:
     class View extends Backbone.RelationalModel</p>

<pre><code> View.setup()

 class Property extends Backbone.RelationalModel
   relations: [
     type: Backbone.HasOne
     key: 'view'
     relatedModel: View
     reverseRelation:
       type: Backbone.HasMany
       key: 'properties'
   ]

 Property.setup()
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>			
			<span class="kd">var</span> <span class="nx">Property</span><span class="p">,</span> <span class="nx">View</span><span class="p">,</span>
			  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
			  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

			<span class="nx">View</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

			  <span class="nx">__extends</span><span class="p">(</span><span class="nx">View</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

			  <span class="nx">View</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;View&#39;</span><span class="p">;</span>

			  <span class="kd">function</span> <span class="nx">View</span><span class="p">()</span> <span class="p">{</span>
			    <span class="k">return</span> <span class="nx">View</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
			  <span class="p">}</span>

			  <span class="k">return</span> <span class="nx">View</span><span class="p">;</span>

			<span class="p">})(</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">);</span>
			
			<span class="nx">View</span><span class="p">.</span><span class="nx">setup</span><span class="p">();</span>

			<span class="nx">Property</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

			  <span class="nx">__extends</span><span class="p">(</span><span class="nx">Property</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

			  <span class="nx">Property</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;Property&#39;</span><span class="p">;</span>

			  <span class="kd">function</span> <span class="nx">Property</span><span class="p">()</span> <span class="p">{</span>
			    <span class="k">return</span> <span class="nx">Property</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
			  <span class="p">}</span>

			  <span class="nx">Property</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">relations</span> <span class="o">=</span> <span class="p">[</span>
			    <span class="p">{</span>
			      <span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
			      <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span>
			      <span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">View</span><span class="p">,</span>
			      <span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
			        <span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span><span class="p">,</span>
			        <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;properties&#39;</span>
			      <span class="p">}</span>
			    <span class="p">}</span>
			  <span class="p">];</span>

			  <span class="k">return</span> <span class="nx">Property</span><span class="p">;</span>

			<span class="p">})(</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">);</span>
			
			<span class="nx">Property</span><span class="p">.</span><span class="nx">setup</span><span class="p">();</span>

			<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">View</span><span class="p">({</span>
				<span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				<span class="nx">properties</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;300px&#39;</span> <span class="p">}</span> <span class="p">]</span>
			<span class="p">});</span>

			<span class="nx">ok</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;properties&#39;</span> <span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span> <span class="p">);</span>
		<span class="p">});</span>


		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;ReverseRelations are applied retroactively&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Use brand new Model types, so we can be sure we don't have any reverse relations cached from previous tests</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">NewUser</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
			<span class="kd">var</span> <span class="nx">NewPerson</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
				<span class="nx">relations</span><span class="o">:</span> <span class="p">[{</span>
					<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
					<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
					<span class="nx">relatedModel</span><span class="o">:</span> <span class="nx">NewUser</span><span class="p">,</span>
					<span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span>
						<span class="nx">type</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span><span class="p">,</span>
						<span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;person&#39;</span>
					<span class="p">}</span>
				<span class="p">}]</span>
			<span class="p">});</span>
			
			<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NewUser</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;newuser-1&#39;</span> <span class="p">}</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>var user2 = new NewUser( { id: 'newuser-2', person: 'newperson-1' } );</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NewPerson</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;newperson-1&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">user</span> <span class="p">}</span> <span class="p">);</span>
			
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">user</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">person</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>console.debug( person, user );</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">});</span>
	
	
	<span class="nx">module</span><span class="p">(</span> <span class="s2">&quot;Model loading&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">setup</span><span class="o">:</span> <span class="nx">initObjects</span> <span class="p">}</span> <span class="p">);</span>
	
	
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Loading (fetching) multiple times updates the model&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">collA</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>
			<span class="nx">collA</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">User</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">collB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>
			<span class="nx">collB</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">User</span><span class="p">;</span>
			</pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Similar to what happens when calling 'fetch' on collA, updating it, calling 'fetch' on collB</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;User 1&#39;</span><span class="p">;</span>
			<span class="nx">collA</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;/user/1/&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span> <span class="p">}</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">collA</span><span class="p">.</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;name&#39;</span> <span class="p">),</span> <span class="nx">name</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>The 'name' of 'user' is updated when adding a new hash to the collection</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;New name&#39;</span><span class="p">;</span>
			<span class="nx">collA</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;/user/1/&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span> <span class="p">}</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">updatedUser</span> <span class="o">=</span> <span class="nx">collA</span><span class="p">.</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;name&#39;</span> <span class="p">),</span> <span class="nx">name</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">updatedUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;name&#39;</span> <span class="p">),</span> <span class="nx">name</span> <span class="p">);</span>
			</pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>The 'name' of 'user' is also updated when adding a new hash to another collection</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;Another new name&#39;</span><span class="p">;</span>
			<span class="nx">collB</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;/user/1/&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Superuser&#39;</span> <span class="p">}</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">updatedUser2</span> <span class="o">=</span> <span class="nx">collA</span><span class="p">.</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;name&#39;</span> <span class="p">),</span> <span class="nx">name</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">updatedUser2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="nx">name</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>console.log( collA.models, collA.get( '/user/1/' ), user, updatedUser, updatedUser2 );</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">ok</span><span class="p">(</span> <span class="nx">collA</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/user/1/&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">updatedUser</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">collA</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/user/1/&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">updatedUser2</span> <span class="p">);</span>
			<span class="nx">ok</span><span class="p">(</span> <span class="nx">collB</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/user/1/&#39;</span> <span class="p">)</span> <span class="o">===</span> <span class="nx">user</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Loading (fetching) multiple times updates related models as well (HasOne)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">coll</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PersonCollection</span><span class="p">();</span>
			<span class="nx">coll</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;person-10&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Person&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;user-10&#39;</span><span class="p">,</span> <span class="nx">login</span><span class="o">:</span> <span class="s1">&#39;User&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>

			<span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;user&#39;</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;login&#39;</span> <span class="p">),</span> <span class="s1">&#39;User&#39;</span> <span class="p">);</span>

			<span class="nx">coll</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;person-10&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;New person&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;user-10&#39;</span><span class="p">,</span> <span class="nx">login</span><span class="o">:</span> <span class="s1">&#39;New user&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;name&#39;</span> <span class="p">),</span> <span class="s1">&#39;New person&#39;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;login&#39;</span> <span class="p">),</span> <span class="s1">&#39;New user&#39;</span> <span class="p">);</span>
		<span class="p">});</span>
		
		<span class="nx">test</span><span class="p">(</span> <span class="s2">&quot;Loading (fetching) multiple times updates related models as well (HasMany)&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">coll</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>
			<span class="nx">coll</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">Zoo</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Create a 'zoo' with 1 animal in it</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">coll</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;zoo-1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Zoo&#39;</span><span class="p">,</span> <span class="nx">animals</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;lion-1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Mufasa&#39;</span> <span class="p">}</span> <span class="p">]</span> <span class="p">}</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">zoo</span> <span class="o">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
			<span class="kd">var</span> <span class="nx">lion</span> <span class="o">=</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;animals&#39;</span> <span class="p">)</span> <span class="p">.</span><span class="nx">at</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">lion</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;name&#39;</span> <span class="p">),</span> <span class="s1">&#39;Mufasa&#39;</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Update the name of 'zoo' and 'lion'</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">coll</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;zoo-1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Zoo Station&#39;</span><span class="p">,</span> <span class="nx">animals</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;lion-1&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Simba&#39;</span> <span class="p">}</span> <span class="p">]</span> <span class="p">}</span> <span class="p">);</span>

			<span class="nx">equal</span><span class="p">(</span> <span class="nx">zoo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;name&#39;</span> <span class="p">),</span> <span class="s1">&#39;Zoo Station&#39;</span> <span class="p">);</span>
			<span class="nx">equal</span><span class="p">(</span> <span class="nx">lion</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;name&#39;</span> <span class="p">),</span> <span class="s1">&#39;Simba&#39;</span> <span class="p">);</span>
		<span class="p">});</span>
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 